# OpenVox Packaging

Every bit used except for the Vox Pupuli OpenVox private key is available in public repos in the `OpenVoxProject` Github org.

Building off of [the work Jeff Clark did to improve Docker support in Vanagon](https://github.com/ospuppet/vanagon), we [added a bunch more things](https://github.com/openvoxproject/vanagon/commit/f439446bfc885bde34da8d3b32f28ab1f72bd6d3) (and more since!) to make building these packages with containers work better. The choice of container images for each platform can be found in the [platform default files](https://github.com/OpenVoxProject/vanagon/tree/main/lib/vanagon/platform/defaults). We also tried to standardize the platform defaults a bit since they've gotten rather divergent over the years. Using containerized builds also allows us to build for different architectures without having to build on a system of that particular architecture.

Generally, you will be able to build all packages locally yourself by using Rake tasks, or a GitHub action set up for this purpose.

## `openvox-agent`

In some cases, Perforce uses their own internal version of build tools (pl-build-tools) to build for older platforms that ship with build tools that are tool old.  Rather than do this, we've moved utilizing publicly available updated tools instead. These days, that seems to be mostly for el7.

There are three component repos that are required for building the agent.
* [puppet-runtime](https://github.com/openvoxproject/puppet-runtime) - vanagon repo containing components packaged in the All-In-One (AIO) agent package
* [pxp-agent-vanagon](https://github.com/openvoxproject/pxp-agent-vanagon) - pxp-agent is primarily used by Puppet Enterprise for orchestration, but some pieces are used by members of the community
* [openvox-agent](https://github.com/openvoxproject/openvox-agent) - the vanagon repo that creates the rpm/deb packages

Within these repos, you'll find the following rake tasks.

* `vox:tag['<tag>']` - This tags the repo and pushes the tag to origin.
* `vox:build['<project>','<platform>']` - This takes a project name (found in `configs/project`) and platform to build for (found in `configs/platforms`) and performs the build using vanagon's `docker` engine. The component will be built inside the container, and files will end up in the `output` directory of your repo clone.
* `vox:upload['<tag>','<platform>']` - This uploads the artifacts generated by the build to the [OSL puppet-artifacts S3 bucket](https://artifacts.overlookinfratech.com) or potentially a different S3 bucket if desired. You won't be able to use this without the AWS CLI set up with appropriate secrets.
* `vox:promote_runtime['<puppet-runtime tag>']` - Found in the [pxp-agent-vanagon](https://github.com/OpenVoxProject/pxp-agent-vanagon) repo, this modifies the [puppet-runtime.json](https://github.com/OpenVoxProject/pxp-agent-vanagon/blob/main/configs/components/puppet-runtime.json) file to point to a given tagged puppet-runtime version that exists in the [OSL puppet-artifacts S3 bucket](https://artifacts.overlookinfratech.com). You can modify this file manually to point to a directory on disk by changing `location` to `file:///path/to/puppet-runtime/output`.
* `vox:promote['<component>','<tag>']` - This more generic task is found in the [openvox-agent repo](https://github.com/OpenVoxProject/openvox-agent/blob/main/tasks/promote.rake) and can be used for promoting tagged builds of both `puppet-runtime` and `pxp-agent`.

First, `puppet-runtime` is built and uploaded to the [puppet-runtime artifacts directory](https://artifacts.overlookinfratech.com/#puppet-runtime/). Then `pxp-agent`, which utilizes `puppet-runtime` and is uploaded to the [pxp-agent artifacts directory](https://artifacts.overlookinfratech.com/#pxp-agent/), then `openvox-agent` which utilizes both and is uploaded to the [openvox-agent artifacts directory](https://artifacts.overlookinfratech.com/#openvox-agent/). In this last directory, the rpm and deb agent packages are stored, but these are unsigned.

The process for building the agent is now mostly in GitHub Actions. They share a [build_vanagon.yml](https://github.com/OpenVoxProject/shared-actions/blob/main/.github/workflows/build_vanagon.yml) workflow, which contains the full list of platforms that OpenVox currently supports for the agent. An example of how this shared workflow is used can be found in [puppet-runtime](https://github.com/OpenVoxProject/puppet-runtime/blob/main/.github/workflows/build.yml). The shared workflow is able to upload these artifacts to the appropriate S3 bucket locations.

## `openvox-server/openvoxdb`

These are built using our slightly tweaked version of [ezbake](https://github.com/openvoxproject/ezbake) which allows us to change the name of the packages.
The [openvox-server](https://github.com/openvoxproject/openvox-server) and [openvoxdb](https://github.com/openvoxproject/openvoxdb) repos contain similar rake tasks, but are used slightly differently

* `vox:tag['<tag>']` - First, this changes the version found in [project.clj](https://github.com/OpenVoxProject/openvox-server/blob/0b234826d3df19c760d33460ef0ea1852da01eb4/project.clj#L1) to the tag and commits that change. Then it tags the repo. Then it creates a new commit after the tag that increments the Z part of the version with `-SNAPSHOT`, following the current convention for these repos. Finally, it pushes the branch and the tag to origin.
* `vox:build['<tag>']` - Because the `vox:tag` task ends up creating a commit after the tag, this checks out the tag you want to build first. Then, it creates a container to do the ezbake build, and saves the artifacts to the `output` directory in your repo clone. Note that since these projects are fairly platform-agnostic, all of the packages can be built inside a single container. This container must be rpm-based, as `rpmbuild` is needed by `fpm` to create the rpms, but no special packages are needed to build the debs. At the moment, all platforms to build for are defined in the rake task.
* `vox:upload['<tag>','<optional platform>']` - This uploads the artifacts generated by the build to the [OSL puppet-artifacts S3 bucket](https://artifacts.overlookinfratech.com) or potentially a different S3 bucket if desired. You won't be able to use this without the AWS CLI set up with appropriate secrets.

At the moment, these tasks must be run locally. They will soon be incorporated into GitHub Action workflows.

## Signing packages and creating the repos

To create the repository packages (i.e. the rpm files at https://yum.overlookinfratech.com/ to set up the repo on your machine), [openvox-release](https://github.com/openvoxproject/openvox-release) is used. The packages this generates will place the public key in the right place and import it, and set up the appropriate [apt](https://apt.overlookinfratech.com)/[yum](https://yum.overlookinfratech.com) repo on your machine.

Signing is performed using the [sign_from_s3.rb](https://github.com/OpenVoxProject/misc/blob/main/signing/sign_from_s3.rb) script run on @nmburgan 's machine. You won't be able to use this yourself without the private signing key, but you can see the code used. It downloads the unsigned packages from the [OSL puppet-artifacts S3 bucket](https://artifacts.overlookinfratech.com), signs them, then incorporates them into yum and apt repos, which are then later synced to the S3 buckets. The apt repo is currently maintained with the [aptly](https://www.aptly.info/) tool. At some point, we'll move this to a more automated and sustainable workflow.

### Disclaimer

The build machinery is all very new code, written to get things up and running as fast as possible. While we are fairly confident the packages should work as well as the last Perforce-built open source Puppet packages, we do not yet have the testing infrastructure that Perforce does. We'll be working on this soon!
